/**
 * Email Service Component
 * X·ª≠ l√Ω vi·ªác g·ª≠i email t·ª´ form li√™n h·ªá v√† newsletter
 */
class EmailService {
    constructor() {
        // Detect environment
        this.isProduction = window.location.hostname === 'shrimptech.vn' || 
                           window.location.hostname === 'shrimptech-web.web.app' ||
                           window.location.protocol === 'https:';
        
        // Configure API endpoints based on environment
        if (this.isProduction) {
            this.apiEndpoints = [
                'https://shrimptech-api.railway.app/api',     // Railway deployment
                'https://shrimptech-web.vercel.app/api',      // Vercel deployment  
                'https://shrimptech-web.netlify.app/.netlify/functions', // Netlify functions
                '/api'                                         // Current domain fallback
            ];
        } else {
            this.apiEndpoints = [
                'http://localhost:3002/api',
                'http://localhost:3001/api',
                'http://127.0.0.1:3002/api',
                'http://127.0.0.1:3001/api',
                '/api'
            ];
        }
        
        this.projectEmail = 'shrimptech.vhu.hutech@gmail.com';
        this.init();
    }

    init() {
        console.log(`üìß EmailService initialized for ${this.isProduction ? 'PRODUCTION' : 'DEVELOPMENT'}`);
        console.log('API endpoints:', this.apiEndpoints);
    }

    /**
     * Try multiple API endpoints until one works
     */
    async makeRequest(endpoint, data) {
        console.log(`üåê EmailService attempting to send to ${endpoint}:`, data);
        
        for (const baseUrl of this.apiEndpoints) {
            const fullUrl = `${baseUrl}${endpoint}`;
            
            try {
                console.log(`Trying endpoint: ${fullUrl}`);
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                console.log(`Response from ${fullUrl}:`, response.status, response.statusText);

                if (!response.ok) {
                    const error = await response.text();
                    console.error(`API Error from ${fullUrl}:`, error);
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }

                const result = await response.json();
                console.log(`‚úÖ Success from ${fullUrl}:`, result);
                return result;
                
            } catch (error) {
                console.warn(`‚ùå Failed to connect to ${fullUrl}:`, error.message);
                // Continue to next endpoint
            }
        }
        
        throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn email server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.');
    }

    /**
     * G·ª≠i email t·ª´ form li√™n h·ªá
     */
    async sendContactEmail(formData) {
        console.log('üìß EmailService sending contact email:', formData);
        return await this.makeRequest('/contact', formData);
    }

    /**
     * G·ª≠i email ƒëƒÉng k√Ω newsletter
     */
    async sendNewsletterEmail(email) {
        console.log('üì¨ EmailService sending newsletter email:', email);
        return await this.makeRequest('/newsletter', { email });
    }

    /**
     * Convert farm type code to text
     */
    getFarmTypeText(farmType) {
        const types = {
            'pond-small': 'Ao tr√≤n n·ªïi (50-700m¬≤)',
            'pond-medium': 'Ao l√≥t b·∫°t ƒë√°y (700‚Äì1.000m¬≤)',
            'pond-large': 'Ao si√™u th√¢m canh t·ªïng h·ª£p (1.000‚Äì3.000m¬≤ m·ªói ao)',
            'research': 'Nghi√™n c·ª©u/H·ªçc thu·∫≠t',
            'other': 'Kh√°c'
        };
        return types[farmType] || farmType;
    }

    /**
     * Convert subject code to text
     */
    getSubjectText(subject) {
        const subjects = {
            'product-info': 'Th√¥ng tin s·∫£n ph·∫©m',
            'consultation': 'T∆∞ v·∫•n h·ªá th·ªëng',
            'technical': 'T∆∞ v·∫•n k·ªπ thu·∫≠t',
            'installation': 'L·∫Øp ƒë·∫∑t & b·∫£o tr√¨',
            'partnership': 'H·ª£p t√°c ƒë·∫°i l√Ω',
            'research': 'H·ª£p t√°c nghi√™n c·ª©u',
            'other': 'Kh√°c'
        };
        return subjects[subject] || subject;
    }
}

// Export for use in other modules
window.EmailService = EmailService;
